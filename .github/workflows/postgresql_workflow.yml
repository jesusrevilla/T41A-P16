name: Run PostgreSQL Project

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # Nota: No necesitamos Python ni 'requirements.txt' esta vez
    # porque no hay tests de pytest.

    - name: Wait for PostgreSQL
      run: |
        sleep 10

    - name: 01 Create Tables
      run: |
        PGPASSWORD=postgres psql -h localhost -U postgres -d test_db -f ${{ github.workspace }}/01_create_tables.sql

    - name: 02 Create Trigger
      run: |
        PGPASSWORD=postgres psql -h localhost -U postgres -d test_db -f ${{ github.workspace }}/02_create_trigger.sql    

    - name: 03 Create Procedure Movimiento
      run: |
        PGPASSWORD=postgres psql -h localhost -U postgres -d test_db -f ${{ github.workspace }}/03_create_procedure_movimiento.sql

    - name: 04 Create Function Valor Inventario
      run: |
        PGPASSWORD=postgres psql -h localhost -U postgres -d test_db -f ${{ github.workspace }}/04_create_function_valor_inventario.sql

    - name: 05 Run Simulation
      run: |
        PGPASSWORD=postgres psql -h localhost -U postgres -d test_db -f ${{ github.workspace }}/05_run_simulation.sql
